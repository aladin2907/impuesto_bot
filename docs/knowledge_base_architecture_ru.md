# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π - –ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## üéØ –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

### –î–≤–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:

**Supabase (PostgreSQL)** ‚Üí –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- ID –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –í–µ—Ä—Å–∏–∏
- –°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –°–≤—è–∑–∏ –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- –õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**Elasticsearch** ‚Üí –ü–æ–∏—Å–∫–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
- –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
- –í–µ–∫—Ç–æ—Ä–Ω—ã–µ embeddings
- –ë—ã—Å—Ç—Ä—ã–π –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
- –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –°–≤—è–∑—å –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏:
–ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏–º–µ–µ—Ç:
- `id` –≤ Supabase (–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
- `elasticsearch_doc_id` (—Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å)

---

## üì¶ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∞–±–ª–∏—Ü—ã

### 1. Telegram —Ç—Ä–µ–¥—ã ‚Üí `telegram_threads_metadata`

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Supabase:**
```sql
{
  "thread_id": 21565,
  "group_name": "IT Autonomos Spain",
  "message_count": 20,
  "quality_score": 5.0,
  "topics": ["tax", "visa", "business"],
  "keywords": ["–∞–≤—Ç–æ–Ω–æ–º–æ", "–Ω–∞–ª–æ–≥", "ss"],
  "tax_related": true,
  "elasticsearch_doc_id": "it_autonomos_21565",
  "raw_data": {...}  -- –ø–æ–ª–Ω—ã–π JSON —Ç—Ä–µ–¥–∞
}
```

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Elasticsearch:**
```json
{
  "supabase_id": "uuid-xxx",
  "content": "–í–µ—Å—å —Ç–µ–∫—Å—Ç –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...",
  "content_embedding": [0.123, 0.456, ...],
  "first_message": "–¢–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...",
  "topics": ["tax", "visa"],
  "quality_score": 5.0
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ (cron)
- –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é
- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–µ–¥—ã –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ
- –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –≤ Elasticsearch

---

### 2. PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Üí `pdf_documents_metadata`

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Supabase:**
```sql
{
  "document_title": "Ley 35/2006 IRPF",
  "document_type": "law",
  "source_url": "https://...",
  "file_hash": "sha256...",
  "is_latest_version": true,
  "chunks_count": 245,
  "processing_status": "completed",
  "categories": ["irpf", "autonomos"]
}
```

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Elasticsearch:**
- –ö–∞–∂–¥—ã–π —á–∞–Ω–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
- –í—Å–µ —á–∞–Ω–∫–∏ —Å–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ `document_id`

```json
{
  "document_id": "uuid-xxx",
  "chunk_id": "uuid-yyy",
  "supabase_id": "uuid-xxx",
  "content": "–¢–µ–∫—Å—Ç —á–∞–Ω–∫–∞...",
  "content_embedding": [0.123, ...],
  "chunk_index": 5,
  "page_number": 12,
  "document_title": "Ley 35/2006 IRPF"
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ü–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (manual)
- –ü—Ä–æ–≤–µ—Ä—è–µ–º hash —Ñ–∞–π–ª–∞
- –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí –ø–µ—Ä–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —á–∞–Ω–∫–∏ –∏–∑ Elasticsearch
- –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ

---

### 3. –ù–æ–≤–æ—Å—Ç–∏ ‚Üí `news_articles_metadata`

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Supabase:**
```sql
{
  "article_url": "https://...",
  "article_title": "Cambios en IRPF 2025",
  "news_source": "Expansion",
  "published_at": "2025-10-01",
  "relevance_score": 0.85,
  "categories": ["irpf", "cambios_legislativos"],
  "is_relevant": true
}
```

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Elasticsearch:**
```json
{
  "supabase_id": "uuid-xxx",
  "title": "Cambios en IRPF 2025",
  "content": "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏...",
  "content_embedding": [0.123, ...],
  "published_at": "2025-10-01",
  "news_source": "Expansion"
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ï–∂–µ–¥–Ω–µ–≤–Ω–æ (cron)
- –°–∫—Ä–∞–ø–∏–º –Ω–æ–≤–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ LLM
- –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ

---

### 4. –ù–∞–ª–æ–≥–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚Üí `calendar_deadlines`

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Supabase:**
```sql
{
  "deadline_date": "2025-10-20",
  "tax_type": "IVA",
  "tax_model": "Modelo 303",
  "description": "IVA –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π –∑–∞ Q3 2025",
  "applies_to": ["autonomos", "empresas"],
  "quarter": "Q3",
  "year": 2025
}
```

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Elasticsearch:**
```json
{
  "supabase_id": "uuid-xxx",
  "description": "IVA –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π –∑–∞ Q3 2025...",
  "content_embedding": [0.123, ...],
  "deadline_date": "2025-10-20",
  "tax_type": "IVA",
  "applies_to": ["autonomos"]
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ï–∂–µ–≥–æ–¥–Ω–æ + –µ–∂–µ–º–µ—Å—è—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- –°–∫—Ä–∞–ø–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å AEAT
- –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

---

### 4b. AEAT iCalendar (—Å—ã—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è) ‚Üí `calendar_events`

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ Supabase:**
```json
{
  "uid": "event-uuid",
  "calendar_type": "iva",
  "summary": "Presentaci√≥n modelo 303",
  "dtstart": "2025-03-20T09:00:00+01:00",
  "status": "CONFIRMED",
  "sequence": 3,
  "is_active": true,
  "raw": "BEGIN:VEVENT...END:VEVENT"
}
```

**–ó–∞—á–µ–º:**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–æ—á–Ω—É—é –∫–æ–ø–∏—é –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö .ics (Google Calendar) AEAT.
- –¢—Ä–µ–∫–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è `STATUS`/`SEQUENCE` –∏ –æ—Ç–º–µ–Ω—ã (`STATUS:CANCELLED`).
- –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ `calendar_deadlines` –∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–°–∫—Ä–∏–ø—Ç:** `python scripts/ingestion/sync_aeat_calendar.py`

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ (cron / GitHub Actions) ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.

---

## üîÑ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 1. Telegram (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ - –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 2:00)

```bash
# Cron: 0 2 * * 0
python scripts/telegram/update_threads_weekly.py
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–¥–∞:
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤ `telegram_threads_metadata`
   - –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º (`version++`)
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π
3. –û–±–Ω–æ–≤–ª—è–µ–º –≤ Elasticsearch:
   - –ï—Å–ª–∏ —Ç—Ä–µ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí `es.update()`
   - –ï—Å–ª–∏ –Ω–æ–≤—ã–π ‚Üí `es.index()`
4. –õ–æ–≥–∏—Ä—É–µ–º –≤ `sync_logs`

---

### 2. –ù–æ–≤–æ—Å—Ç–∏ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å 6:00)

```bash
# Cron: 0 6 * * *
python scripts/ingestion/ingest_news_daily.py
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –°–∫—Ä–∞–ø–∏–º –Ω–æ–≤–æ—Å—Ç–∏ —Å 5-7 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ `article_url`
3. –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ LLM (gemini-1.5-flash)
4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ
5. –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –≤ Elasticsearch
6. –õ–æ–≥–∏—Ä—É–µ–º –≤ `sync_logs`

---

### 3. PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã (–ø–æ –∑–∞–ø—Ä–æ—Å—É)

```bash
# Manual –∏–ª–∏ –ø–æ —Å–æ–±—ã—Ç–∏—é (webhook –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)
python scripts/ingestion/ingest_pdf_documents.py --source-id <uuid>
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –°–∫–∞—á–∏–≤–∞–µ–º PDF —Ñ–∞–π–ª
2. –í—ã—á–∏—Å–ª—è–µ–º hash
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ (`file_hash != old_hash`)
4. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è:
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º PDF ‚Üí —á–∞–Ω–∫–∏
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º embeddings
   - –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —á–∞–Ω–∫–∏ –∏–∑ Elasticsearch
   - –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ
   - –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ Supabase
5. –õ–æ–≥–∏—Ä—É–µ–º –≤ `sync_logs`

---

### 4. –ö–∞–ª–µ–Ω–¥–∞—Ä—å (–µ–∂–µ–º–µ—Å—è—á–Ω–æ - 1-–≥–æ —á–∏—Å–ª–∞ 3:00)

```bash
# Cron: 0 3 1 * *
python scripts/ingestion/update_tax_calendar.py
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –°–∫—Ä–∞–ø–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å AEAT
2. –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—ã –Ω–∞ —Ç–µ–∫—É—â–∏–π + —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ–¥–ª–∞–π–Ω–∞:
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤ `calendar_deadlines`
   - –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º
4. –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –≤ Elasticsearch (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

---

## üîé –ö–∞–∫ –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ

### –ü—Ä–∏–º–µ—Ä –ø–æ–∏—Å–∫–∞: "–ö–æ–≥–¥–∞ –ø–ª–∞—Ç–∏—Ç—å IVA –∞–≤—Ç–æ–Ω–æ–º–æ—Å?"

#### 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
```python
query_type = classify_query("–ö–æ–≥–¥–∞ –ø–ª–∞—Ç–∏—Ç—å IVA –∞–≤—Ç–æ–Ω–æ–º–æ—Å?")
# –†–µ–∑—É–ª—å—Ç–∞—Ç: "calendar" + "tax"
```

#### 2. –ò—â–µ–º –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω–¥–µ–∫—Å–∞—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

**A. –ü–æ–∏—Å–∫ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ** (–≤–µ—Å 0.5)
```python
calendar_results = es.search(index="calendar_deadlines", body={
    "query": {
        "bool": {
            "should": [
                {"knn": {"field": "content_embedding", "query_vector": embedding, "k": 3}},
                {"match": {"description": "IVA –∞–≤—Ç–æ–Ω–æ–º–æ—Å"}}
            ],
            "filter": [
                {"term": {"tax_type": "IVA"}},
                {"term": {"applies_to": "autonomos"}},
                {"range": {"deadline_date": {"gte": "now"}}}
            ]
        }
    }
})
```

**B. –ü–æ–∏—Å–∫ –≤ Telegram** (–≤–µ—Å 0.3)
```python
telegram_results = es.search(index="telegram_threads", body={
    "query": {
        "bool": {
            "should": [
                {"knn": {"field": "content_embedding", "query_vector": embedding, "k": 5}},
                {"multi_match": {"query": "IVA –∞–≤—Ç–æ–Ω–æ–º–æ—Å", "fields": ["content", "first_message"]}}
            ],
            "filter": [
                {"term": {"tax_related": True}},
                {"range": {"quality_score": {"gte": 2.0}}}
            ]
        }
    }
})
```

**C. –ü–æ–∏—Å–∫ –≤ PDF** (–≤–µ—Å 0.2)
```python
pdf_results = es.search(index="pdf_documents", body={
    "query": {
        "bool": {
            "should": [
                {"knn": {"field": "content_embedding", "query_vector": embedding, "k": 3}},
                {"match": {"content": "IVA"}}
            ],
            "filter": [
                {"terms": {"categories": ["iva", "autonomos"]}}
            ]
        }
    }
})
```

#### 3. –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Ä–∞–Ω–∂–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

```python
# –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–µ—Å–∞
calendar_weighted = [r for r in calendar_results with weight=0.5]
telegram_weighted = [r for r in telegram_results with weight=0.3]
pdf_weighted = [r for r in pdf_results with weight=0.2]

# –û–±—ä–µ–¥–∏–Ω—è–µ–º
all_results = calendar_weighted + telegram_weighted + pdf_weighted

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏—Ç–æ–≥–æ–≤–æ–º—É score
ranked_results = sorted(all_results, key=lambda x: x.final_score, reverse=True)[:10]
```

#### 4. –û–±–æ–≥–∞—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Supabase

```python
enriched_results = []
for result in ranked_results:
    # –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    if result.index == "calendar_deadlines":
        metadata = supabase.table("calendar_deadlines").select("*").eq("id", result.supabase_id).single()
    elif result.index == "telegram_threads":
        metadata = supabase.table("telegram_threads_metadata").select("*").eq("id", result.supabase_id).single()
    # ...
    
    enriched_results.append({
        "content": result.content,
        "score": result.final_score,
        "source_type": result.index,
        "metadata": metadata
    })
```

#### 5. –ü–µ—Ä–µ–¥–∞—ë–º –≤ LLM –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç

```python
context = format_context_for_llm(enriched_results)

llm_response = llm.generate(f"""
–ö–æ–Ω—Ç–µ–∫—Å—Ç:
{context}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ö–æ–≥–¥–∞ –ø–ª–∞—Ç–∏—Ç—å IVA –∞–≤—Ç–æ–Ω–æ–º–æ—Å?

–û—Ç–≤–µ—Ç—å —Ç–æ—á–Ω–æ –∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
""")
```

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- **Supabase**: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ª–æ–≥–∏
- **Elasticsearch**: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫, —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –ö–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º

### ‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ `sync_logs`
- –ú–æ–∂–µ–º –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (semantic + BM25)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º
- –í–∑–≤–µ—à–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
- –°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –û—à–∏–±–∫–∏ –∏ –∏—Ö –¥–µ—Ç–∞–ª–∏

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ö–µ–º—É –≤ Supabase**
   ```bash
   psql -h supabase_url -d postgres < database/knowledge_base_schema.sql
   ```

2. **–°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ Elasticsearch**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å mappings –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
   - –í–∫–ª—é—á–∏—Ç—å kNN search –¥–ª—è embeddings

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**
   - Telegram: –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
   - –ù–æ–≤–æ—Å—Ç–∏: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–∫—Ä–∞–ø–µ—Ä
   - PDF: –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ –∑–∞–ø—Ä–æ—Å—É
   - –ö–∞–ª–µ–Ω–¥–∞—Ä—å: –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ–±–Ω–æ–≤–ª—è—Ç–æ—Ä

4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron jobs –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤

5. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å RAG pipeline**
   - Unified search service
   - Context enrichment
   - Source citation

---

*–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ NAIL - Nahornyi AI Lab*
