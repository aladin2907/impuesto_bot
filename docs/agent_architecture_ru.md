# TuExpertoFiscal NAIL: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ò–ò-–∞–≥–µ–Ω—Ç–∞

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

TuExpertoFiscal NAIL - —ç—Ç–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –Ω–∞–ª–æ–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –ò—Å–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–¥–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ò–ò –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–Ω—ã—Ö –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –Ω–∞–ª–æ–≥–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ê–≥–µ–Ω—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ RAG (Retrieval-Augmented Generation) –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   Telegram  ‚îÇ  ‚îÇ  WhatsApp   ‚îÇ  ‚îÇ   Web API   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ     Bot     ‚îÇ  ‚îÇ     Bot     ‚îÇ  ‚îÇ             ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FastAPI Backend                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   Router    ‚îÇ  ‚îÇ  Auth &     ‚îÇ  ‚îÇ   Session   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Handler    ‚îÇ  ‚îÇ  Users      ‚îÇ  ‚îÇ  Manager    ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ò–ò-—è–¥—Ä–æ –∞–≥–µ–Ω—Ç–∞                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   Query     ‚îÇ  ‚îÇ   Context   ‚îÇ  ‚îÇ   Response  ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ Classifier  ‚îÇ  ‚îÇ  Retrieval  ‚îÇ  ‚îÇ  Generator  ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇElasticsearch‚îÇ  ‚îÇ  Supabase   ‚îÇ  ‚îÇ   Vector    ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  (Search)   ‚îÇ  ‚îÇ(Metadata)   ‚îÇ  ‚îÇ   Store     ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üß† –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

```python
class TaxAgent:
    def __init__(self):
        self.query_classifier = QueryClassifier()
        self.context_retriever = ContextRetriever()
        self.response_generator = ResponseGenerator()
        self.session_manager = SessionManager()
    
    async def process_query(self, user_query: str, user_id: str, session_id: str):
        # 1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query_type = await self.query_classifier.classify(user_query)
        
        # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context = await self.context_retriever.retrieve(
            query=user_query,
            query_type=query_type,
            user_profile=await self.get_user_profile(user_id)
        )
        
        # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        response = await self.response_generator.generate(
            query=user_query,
            context=context,
            query_type=query_type,
            session_history=await self.session_manager.get_history(session_id)
        )
        
        # 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        await self.session_manager.save_interaction(
            session_id=session_id,
            user_query=user_query,
            agent_response=response,
            context_sources=context.sources
        )
        
        return response
```

### 2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

–ê–≥–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞:

```python
class QueryClassifier:
    QUERY_TYPES = {
        "tax_calendar": "–í–æ–ø—Ä–æ—Å—ã –æ —Å—Ä–æ–∫–∞—Ö –∏ –¥–µ–¥–ª–∞–π–Ω–∞—Ö",
        "tax_calculation": "–†–∞—Å—á–µ—Ç—ã –Ω–∞–ª–æ–≥–æ–≤ –∏ —Å–±–æ—Ä–æ–≤", 
        "legal_interpretation": "–¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–≤ –∏ –Ω–æ—Ä–º",
        "practical_advice": "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
        "news_update": "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è",
        "general_info": "–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–æ–≥–∞—Ö"
    }
    
    async def classify(self, query: str) -> str:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—É—é LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
        classification_prompt = f"""
        –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–ª–æ–≥–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–∏–ø—É:
        
        –í–æ–ø—Ä–æ—Å: {query}
        
        –¢–∏–ø—ã:
        - tax_calendar: —Å—Ä–æ–∫–∏, –¥–µ–¥–ª–∞–π–Ω—ã, –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        - tax_calculation: —Ä–∞—Å—á–µ—Ç—ã, —Å—É–º–º—ã, —Ñ–æ—Ä–º—É–ª—ã
        - legal_interpretation: –∑–∞–∫–æ–Ω—ã, –Ω–æ—Ä–º—ã, —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ
        - practical_advice: —Å–æ–≤–µ—Ç—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–∞–∫ –¥–µ–ª–∞—Ç—å
        - news_update: –Ω–æ–≤–æ—Å—Ç–∏, –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        - general_info: –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        
        –û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º - —Ç–∏–ø–æ–º –∑–∞–ø—Ä–æ—Å–∞.
        """
        
        result = await self.llm_service.generate(classification_prompt)
        return result.strip().lower()
```

### 3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–ê–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

```python
class ContextRetriever:
    def __init__(self):
        self.elasticsearch = ElasticsearchService()
        self.supabase = SupabaseService()
        self.vector_store = VectorStore()
    
    async def retrieve(self, query: str, query_type: str, user_profile: dict) -> Context:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
        source_weights = self._get_source_weights(query_type)
        
        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
        search_tasks = []
        
        if source_weights["calendar"] > 0:
            search_tasks.append(
                self._search_calendar(query, user_profile)
            )
        
        if source_weights["telegram"] > 0:
            search_tasks.append(
                self._search_telegram(query, user_profile)
            )
        
        if source_weights["pdf_documents"] > 0:
            search_tasks.append(
                self._search_pdf_documents(query, user_profile)
            )
        
        if source_weights["news"] > 0:
            search_tasks.append(
                self._search_news(query, user_profile)
            )
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        search_results = await asyncio.gather(*search_tasks)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Ä–∞–Ω–∂–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        ranked_results = self._rank_and_merge_results(
            search_results, source_weights
        )
        
        return Context(
            content=ranked_results,
            sources=self._extract_sources(ranked_results),
            confidence_score=self._calculate_confidence(ranked_results)
        )
    
    def _get_source_weights(self, query_type: str) -> dict:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Å–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤"""
        weights = {
            "tax_calendar": {"calendar": 0.7, "telegram": 0.2, "pdf_documents": 0.1, "news": 0.0},
            "tax_calculation": {"calendar": 0.2, "telegram": 0.3, "pdf_documents": 0.4, "news": 0.1},
            "legal_interpretation": {"calendar": 0.1, "telegram": 0.2, "pdf_documents": 0.6, "news": 0.1},
            "practical_advice": {"calendar": 0.2, "telegram": 0.5, "pdf_documents": 0.2, "news": 0.1},
            "news_update": {"calendar": 0.1, "telegram": 0.3, "pdf_documents": 0.1, "news": 0.5},
            "general_info": {"calendar": 0.2, "telegram": 0.3, "pdf_documents": 0.3, "news": 0.2}
        }
        return weights.get(query_type, weights["general_info"])
```

### 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞

–ê–≥–µ–Ω—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

```python
class ResponseGenerator:
    def __init__(self):
        self.llm_service = LLMService()
        self.template_engine = TemplateEngine()
    
    async def generate(self, query: str, context: Context, query_type: str, session_history: list) -> Response:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
        system_prompt = self._get_system_prompt(query_type)
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM
        context_text = self._format_context(context)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        history_text = self._format_history(session_history)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        full_prompt = f"""
        {system_prompt}
        
        –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
        {context_text}
        
        –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:
        {history_text}
        
        –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {query}
        
        –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–æ—á–Ω—ã–π, –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
        """
        
        response_text = await self.llm_service.generate(full_prompt)
        
        return Response(
            text=response_text,
            sources=context.sources,
            confidence=context.confidence_score,
            query_type=query_type,
            metadata={
                "context_items_used": len(context.content),
                "response_time": time.time() - start_time
            }
        )
    
    def _get_system_prompt(self, query_type: str) -> str:
        """–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤"""
        prompts = {
            "tax_calendar": """
            –¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–∞–ª–æ–≥–æ–≤–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é –ò—Å–ø–∞–Ω–∏–∏. –û—Ç–≤–µ—á–∞–π —Ç–æ—á–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å—Ä–æ–∫–∞—Ö, 
            –¥–µ–¥–ª–∞–π–Ω–∞—Ö –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.
            """,
            "tax_calculation": """
            –¢—ã –Ω–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Ä–∞—Å—á–µ—Ç–∞–º –≤ –ò—Å–ø–∞–Ω–∏–∏. –ü–æ–º–æ–≥–∞–π —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏ –Ω–∞–ª–æ–≥–æ–≤, 
            —Å–±–æ—Ä–æ–≤ –∏ –≤–∑–Ω–æ—Å–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–π —Ñ–æ—Ä–º—É–ª—ã –∏ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–æ–≤. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–π, 
            —á—Ç–æ —ç—Ç–æ –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.
            """,
            "legal_interpretation": """
            –¢—ã —é—Ä–∏—Å—Ç-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–∞–ª–æ–≥–æ–≤–æ–º—É –ø—Ä–∞–≤—É –ò—Å–ø–∞–Ω–∏–∏. –¢–æ–ª–∫—É–π –∑–∞–∫–æ–Ω—ã –∏ –Ω–æ—Ä–º—ã —Ç–æ—á–Ω–æ, 
            —Å—Å—ã–ª–∞—è—Å—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –†–∞–∑–ª–∏—á–∞–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–æ—Ä–º—ã.
            """,
            "practical_advice": """
            –¢—ã –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏–π –Ω–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ 
            –æ–ø—ã—Ç–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫. –í—Å–µ–≥–¥–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–π –≤–∞–∂–Ω–æ—Å—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.
            """,
            "news_update": """
            –¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ò—Å–ø–∞–Ω–∏–∏. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é 
            –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ, –Ω–æ–≤—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö –∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö.
            """,
            "general_info": """
            –¢—ã –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–∞–ª–æ–≥–∞–º –ò—Å–ø–∞–Ω–∏–∏. –û—Ç–≤–µ—á–∞–π –Ω–∞ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, 
            –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏ –ø–æ–Ω—è—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
            """
        }
        return prompts.get(query_type, prompts["general_info"])
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞

### –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ Telegram/WhatsApp/API
2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –ø–æ–¥–ø–∏—Å–∫–∏
3. **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è** - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞ (0.1-0.3 —Å–µ–∫)
4. **–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (0.5-1.0 —Å–µ–∫)
5. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞** - LLM —Å–æ–∑–¥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (1.0-3.0 —Å–µ–∫)
6. **–ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞** - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (0.1-0.2 —Å–µ–∫)
7. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –ó–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
8. **–û—Ç–ø—Ä–∞–≤–∫–∞** - –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

```
–û–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 2-5 —Å–µ–∫—É–Ω–¥
‚îú‚îÄ‚îÄ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: 0.1-0.3 —Å–µ–∫
‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: 0.5-1.0 —Å–µ–∫
‚îú‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞: 1.0-3.0 —Å–µ–∫
‚îú‚îÄ‚îÄ –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞: 0.1-0.2 —Å–µ–∫
‚îî‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: 0.1-0.2 —Å–µ–∫
```

## üéØ –¢–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞

### 1. –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
**–ü—Ä–∏–º–µ—Ä:** "–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–¥–∞—Ç—å IVA –∑–∞ 3 –∫–≤–∞—Ä—Ç–∞–ª?"

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ö–∞–ª–µ–Ω–¥–∞—Ä—å (70%) + Telegram (20%) + PDF (10%)
- –ü–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–∞–º, –∫–≤–∞—Ä—Ç–∞–ª–∞–º, —Ç–∏–ø–∞–º –Ω–∞–ª–æ–≥–æ–≤
- –û—Ç–≤–µ—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏

### 2. –†–∞—Å—á–µ—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã  
**–ü—Ä–∏–º–µ—Ä:** "–°–∫–æ–ª—å–∫–æ –∑–∞–ø–ª–∞—Ç–∏—Ç—å IRPF —Å 50000 –µ–≤—Ä–æ?"

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã (40%) + Telegram (30%) + –ö–∞–ª–µ–Ω–¥–∞—Ä—å (20%) + –ù–æ–≤–æ—Å—Ç–∏ (10%)
- –ü–æ–∏—Å–∫ —Ñ–æ—Ä–º—É–ª, —Å—Ç–∞–≤–æ–∫, –ø—Ä–∏–º–µ—Ä–æ–≤ —Ä–∞—Å—á–µ—Ç–æ–≤
- –û—Ç–≤–µ—Ç —Å –ø–æ—à–∞–≥–æ–≤—ã–º —Ä–∞—Å—á–µ—Ç–æ–º –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏

### 3. –ü—Ä–∞–≤–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
**–ü—Ä–∏–º–µ—Ä:** "–ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω –æ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –ª—å–≥–æ—Ç–∞—Ö –¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–æ—Å?"

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã (60%) + Telegram (20%) + –ö–∞–ª–µ–Ω–¥–∞—Ä—å (10%) + –ù–æ–≤–æ—Å—Ç–∏ (10%)
- –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π, –∑–∞–∫–æ–Ω–æ–≤, –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π
- –û—Ç–≤–µ—Ç —Å —Ü–∏—Ç–∞—Ç–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã

### 4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
**–ü—Ä–∏–º–µ—Ä:** "–ö–∞–∫ –ª—É—á—à–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç –¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–æ—Å?"

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Telegram (50%) + PDF (20%) + –ö–∞–ª–µ–Ω–¥–∞—Ä—å (20%) + –ù–æ–≤–æ—Å—Ç–∏ (10%)
- –ü–æ–∏—Å–∫ –æ–ø—ã—Ç–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫
- –û—Ç–≤–µ—Ç —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

### 5. –ù–æ–≤–æ—Å—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
**–ü—Ä–∏–º–µ—Ä:** "–ö–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–∞–ª–æ–≥–∞—Ö –æ–∂–∏–¥–∞—é—Ç—Å—è –≤ 2025?"

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–æ–≤–æ—Å—Ç–∏ (50%) + Telegram (30%) + PDF (10%) + –ö–∞–ª–µ–Ω–¥–∞—Ä—å (10%)
- –ü–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π, –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –û—Ç–≤–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏

## üß© –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```python
# app/services/agent/
class TaxAgentService:
    def __init__(self):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
        self.llm_service = LLMService()  # app/services/llm/
        self.elasticsearch_service = ElasticsearchService()  # app/services/elasticsearch/
        self.supabase_service = SupabaseService()  # app/services/supabase_service.py
        
        # –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–∞
        self.query_classifier = QueryClassifier(self.llm_service)
        self.context_retriever = ContextRetriever(
            self.elasticsearch_service, 
            self.supabase_service
        )
        self.response_generator = ResponseGenerator(self.llm_service)
        self.session_manager = SessionManager(self.supabase_service)
    
    async def process_user_query(self, query: str, user_id: str, platform: str):
        """–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é
            session_id = await self.session_manager.get_or_create_session(
                user_id=user_id,
                platform=platform
            )
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
            response = await self.process_query(query, user_id, session_id)
            
            return response
            
        except Exception as e:
            logger.error(f"Error processing query: {e}")
            return self._get_error_response()
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI

```python
# app/main.py
from app.services.agent import TaxAgentService

app = FastAPI()
agent_service = TaxAgentService()

@app.post("/api/v1/query")
async def handle_query(request: QueryRequest):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    response = await agent_service.process_user_query(
        query=request.query,
        user_id=request.user_id,
        platform=request.platform
    )
    return response

@app.post("/webhook/telegram")
async def telegram_webhook(update: dict):
    """Webhook –¥–ª—è Telegram –±–æ—Ç–∞"""
    message = update.get("message", {})
    user_id = message.get("from", {}).get("id")
    query = message.get("text", "")
    
    response = await agent_service.process_user_query(
        query=query,
        user_id=str(user_id),
        platform="telegram"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ Telegram
    await send_telegram_message(user_id, response.text)
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```python
class AgentMetrics:
    def __init__(self):
        self.metrics = {
            "total_queries": 0,
            "response_times": [],
            "query_types": {},
            "confidence_scores": [],
            "error_rate": 0,
            "user_satisfaction": 0
        }
    
    async def track_query(self, query_type: str, response_time: float, confidence: float):
        """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∑–∞–ø—Ä–æ—Å–∞"""
        self.metrics["total_queries"] += 1
        self.metrics["response_times"].append(response_time)
        self.metrics["query_types"][query_type] = self.metrics["query_types"].get(query_type, 0) + 1
        self.metrics["confidence_scores"].append(confidence)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        await self.supabase_service.table("agent_metrics").insert({
            "query_type": query_type,
            "response_time": response_time,
            "confidence_score": confidence,
            "timestamp": datetime.utcnow()
        }).execute()
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

```python
import logging
from app.config.settings import settings

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/agent.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

class AgentLogger:
    @staticmethod
    def log_query_processing(user_id: str, query: str, query_type: str, response_time: float):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞"""
        logger.info(f"Query processed - User: {user_id}, Type: {query_type}, Time: {response_time:.2f}s")
    
    @staticmethod
    def log_error(error: Exception, context: dict):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫"""
        logger.error(f"Agent error: {error}, Context: {context}")
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

```python
# app/config/agent_settings.py
class AgentSettings:
    # LLM –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    DEFAULT_LLM_PROVIDER = "openai"
    FALLBACK_LLM_PROVIDER = "gemini"
    
    # –ü–æ–∏—Å–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    MAX_CONTEXT_ITEMS = 10
    MIN_CONFIDENCE_SCORE = 0.7
    
    # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    MAX_RESPONSE_TIME = 5.0  # —Å–µ–∫—É–Ω–¥
    CACHE_TTL = 300  # —Å–µ–∫—É–Ω–¥
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    MAX_QUERIES_PER_MINUTE = 10
    BLOCKED_QUERIES = ["hack", "exploit", "bypass"]
```

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
import redis
from app.config.settings import settings

redis_client = redis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    db=0
)

class AgentCache:
    def __init__(self):
        self.redis = redis_client
    
    async def get_cached_response(self, query_hash: str):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"""
        cached = self.redis.get(f"agent_response:{query_hash}")
        return json.loads(cached) if cached else None
    
    async def cache_response(self, query_hash: str, response: dict, ttl: int = 300):
        """–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞"""
        self.redis.setex(
            f"agent_response:{query_hash}",
            ttl,
            json.dumps(response)
        )
```

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

1. **–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å** - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ, –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ, —Ä—É—Å—Å–∫–æ–≥–æ
2. **–ì–æ–ª–æ—Å–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å speech-to-text
3. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** - –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. **–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–Ω–∫–∞–º–∏** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
6. **–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** - –ù–∞—Ç–∏–≤–Ω–æ–µ iOS/Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫** - –ü–æ–∏—Å–∫ –ø–æ –≤–Ω–µ—à–Ω–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
2. **–û–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏–µ** - –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
3. **–ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
4. **–û–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
5. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤

---

*–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ NAIL - Nahornyi AI Lab*

YO
